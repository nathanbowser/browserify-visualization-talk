<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <style>

        .container {
          background-color: #fff;
          border: 1px solid #ccc;
          width: 960px;
          height: 600px;
        }

        svg {
          width: 100%;
          height: 100%;
        }

        svg circle.tweet {
          fill: red;
        }

        .countries {
          fill: #cde;
          stroke: #fff;
          stroke-linejoin: round;
          stroke-linecap: round;
        }

        .tweets {
          position: absolute;
          top: 0;
          right: 0;
          border: 1px solid #b3bbbb;
          box-shadow: 0 1px 3px rgba(32,41,55,.11);
          height: 400px;
          list-style: none;
          margin: 0;
          padding: 0;
          width: 350px;
          overflow: auto;
        }

        .tweets li {
          font-size: 14px;
          color: #3a3a3a;
          padding: 20px;
          border-bottom: 1px solid #d5dae1;
        }

        .tweets li:nth-child(odd) {
          background-color: #fafbfc;
        }

        .tweets li:nth-child(even) {
          background-color: #fff;
        }

    </style>
    <script src="bundle.js"></script>
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    <div class="container"></div>
    <ul class="tweets"></ul>
  </body>
<script>
  var socket = io('http://localhost')
    , d3 = require('d3')
    , topojson = require('topojson')
    , projection = d3.geo.mercator()
                     .scale(200)
                     .translate([960 / 2, 600 / 1.5])

  var path = d3.geo.path()
                   .projection(projection)

  var svg = d3.select('.container')
              .append('svg')
    , map = svg.append('g')
                 .attr('class', 'map')
    , dots = svg.append('g')
                 .attr('class', 'tweet-dots')

  d3.json('/world-110m.json', function (err, world) {
    map.append('g')
       .attr('class', 'countries')
       .selectAll('path.country')
       .data(topojson.feature(world, world.objects.countries).features)
       .enter()
       .append('path')
         .attr('d', path)
  })

  var tweets = document.querySelector('.tweets')
    , last = null

  socket.on('tweet', function (tweet) {
    var li = document.createElement('li')
    li.appendChild(document.createTextNode(tweet.text))
    tweets.insertBefore(li, last)
    last = li

    if (tweet.coordinates && tweet.coordinates.type === 'Point') {
      draw({
        id: tweet.id,
        coords: tweet.coordinates.coordinates
      })
    }
  })

  var draw = function (tweet) {
    var _tweets = dots.selectAll('circle.tweet')
                      .data([tweet], function (d) {
                        return d.id
                      })
    _tweets.enter()
      .append('circle')
        .attr('class', 'tweet')
        .attr('r', 8)
        .attr('xlink:href', '#soccer')
        .attr('transform', function (d) {
          return 'translate(' + projection(d.coords) + ')'
        })
        .style('opacity', 1)
        .transition()
        .duration(10000)
        .style('opacity', 0)
        .remove()
  }


</script>
